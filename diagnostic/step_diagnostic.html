<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>WDC - Web Diagnostic Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1em;
            font-weight: 300;
        }

        .steps-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .step-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .step-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .test-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .test-button:hover {
            background: linear-gradient(135deg, #5a6fd8, #6b47a0);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-area {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            min-height: 120px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }

        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-success {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .screenshot-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
        }

        .coordinates-display {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
        }

        .detection-result {
            background: #f3e5f5;
            border: 1px solid #9c27b0;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .step-output-card {
            background: #f8f9fa;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
        }

        .step-output-title {
            background: #28a745;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-weight: bold;
            margin-bottom: 10px;
            display: inline-block;
        }

        .contact-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .contact-relevant {
            border-left: 4px solid #28a745;
            background: #f8fff8;
        }

        .contact-filtered {
            border-left: 4px solid #ffc107;
            background: #fffdf0;
        }

        .message-cards-container {
            margin: 15px 0;
        }

        .message-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            margin: 10px 0;
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .message-card.high-priority {
            border-left: 5px solid #dc3545;
            background: linear-gradient(90deg, #fff5f5 0%, #ffffff 100%);
        }

        .message-card.normal-priority {
            border-left: 5px solid #28a745;
            background: linear-gradient(90deg, #f8fff8 0%, #ffffff 100%);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .card-number {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            background: #f8f9fa;
            padding: 4px 12px;
            border-radius: 20px;
            border: 2px solid #dee2e6;
        }

        .card-priority {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            background: #e9ecef;
            color: #495057;
        }

        .card-content {
            line-height: 1.6;
        }

        .card-field {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-field strong {
            color: #495057;
            min-width: 90px;
        }

        .confidence {
            font-size: 11px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: auto;
        }

        .contact-failed {
            border-left: 4px solid #dc3545;
            background: #fff8f8;
        }

        .coordinates-highlight {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 1.1em;
            font-weight: bold;
        }

        .efficiency-metrics {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .process-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 10px;
            border: 2px solid #4a90e2;
        }

        .process-step {
            text-align: center;
            flex: 1;
        }

        .process-arrow {
            font-size: 1.5em;
            color: #4a90e2;
            margin: 0 10px;
        }

        .combined-test {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            margin-top: 30px;
        }

        .combined-test h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .combined-test-button {
            background: white;
            color: #4caf50;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .combined-test-button:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* Levels Tool Styles */
        .levels-tool {
            background: linear-gradient(135deg, #ff7b7b, #ff6b7d);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
        }

        .levels-tool h3 {
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .levels-tool p {
            text-align: center;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-section h4 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .slider-group {
            margin: 15px 0;
        }

        .slider-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .slider-group input[type="range"] {
            width: 100%;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            height: 8px;
            outline: none;
        }

        .slider-group span {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }

        .apply-button {
            background: white;
            color: #ff6b7d;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .apply-button:hover {
            background: #f0f0f0;
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status-message {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-style: italic;
        }

        .image-preview-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
        }

        .image-container {
            margin-bottom: 20px;
        }

        .image-container h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .log-area {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            color: #d32f2f;
            font-weight: 600;
        }

        .success-message {
            color: #388e3c;
            font-weight: 600;
        }

        .visualization-image {
            max-width: 100%;
            height: auto;
            border: 2px solid #4caf50;
            border-radius: 8px;
            margin: 15px 0;
            display: block;
            cursor: pointer;
        }

        .image-container {
            text-align: center;
            margin: 20px 0;
        }

        .download-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .download-link:hover {
            background: #45a049;
        }

        .legacy-methods {
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .legacy-toggle {
            width: 100%;
            padding: 10px 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            font-size: 0.9em;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s ease;
        }

        .legacy-toggle:hover {
            background: #e9ecef;
        }

        .legacy-toggle .arrow {
            transition: transform 0.2s ease;
        }

        .legacy-toggle.expanded .arrow {
            transform: rotate(90deg);
        }

        .legacy-content {
            display: none;
            padding: 10px 15px 15px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .legacy-content.expanded {
            display: block;
        }

        .legacy-button {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .legacy-button:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            opacity: 1;
        }

        .legacy-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Module Test Card Styles */
        .module-test-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .module-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .module-icon {
            font-size: 3em;
            margin-right: 20px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .module-title h3 {
            font-size: 1.8em;
            margin: 0 0 5px 0;
            font-weight: 600;
        }

        .module-title p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }

        .module-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .module-functions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .function-test {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .function-test:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .module-test-button {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .module-test-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .module-test-button:disabled {
            background: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .module-test-button.comprehensive {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .module-test-button.comprehensive:hover {
            background: linear-gradient(135deg, #ff5252, #ff7043);
        }

        .function-description {
            font-size: 0.95em;
            opacity: 0.9;
            line-height: 1.4;
            margin-top: 8px;
        }

        .module-results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            color: #333;
        }

        .results-header {
            font-size: 1.3em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .results-content {
            font-size: 1em;
            line-height: 1.5;
        }

        .module-test-result {
            margin-bottom: 20px;
        }

        .test-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .test-header h4 {
            margin: 0;
            font-size: 1.2em;
            color: #333;
        }

        .test-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .test-status.success {
            background: #d4edda;
            color: #155724;
        }

        .test-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .test-duration {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            color: #495057;
            margin-left: auto;
        }

        .test-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .test-section h5 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1.1em;
        }

        .test-details {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }

        .test-details.success {
            border-left: 4px solid #28a745;
        }

        .test-details.error {
            border-left: 4px solid #dc3545;
        }

        .screenshot-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .screenshot-item {
            text-align: center;
        }

        .screenshot-item img {
            width: 100%;
        }

        /* OCR Zone Test Card Styles */
        .ocr-zone-test-card {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 15px 35px rgba(156, 39, 176, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .screenshot-item img:hover {
            border-color: #667eea;
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .screenshot-label {
            margin-top: 8px;
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        .individual-test {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 5px 0;
            border-radius: 6px;
        }

        .individual-test.success {
            background: #d4edda;
        }

        .individual-test.error {
            background: #f8d7da;
        }

        .function-name {
            font-weight: 600;
            flex: 1;
        }

        .error-details {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Web Diagnostic Console (WDC)</h1>
            <p class="subtitle">WeChat Bot Component Testing & Visual Verification Console</p>
            <p style="color: #888; font-size: 0.9em; margin-top: 10px; font-style: italic;">
                üìÑ Source: step_diagnostic.html
            </p>
        </div>

        <div class="steps-container">
            <!-- Step 1: Screenshot Capture -->
            <div class="step-card">
                <div class="step-title">
                    <div class="step-number">1</div>
                    Screenshot Capture Module
                    <span id="step1-status" class="status-indicator status-pending">Ready</span>
                </div>
                
                <button id="test-screenshot" class="test-button">
                    üì∏ Test Screenshot Capture
                </button>
                
                <div class="result-area" id="step1-result">
                    Click "Test Screenshot Capture" to verify:
                    ‚Ä¢ WeChat window detection
                    ‚Ä¢ Coordinate recording
                    ‚Ä¢ Precise screenshot capture
                    ‚Ä¢ Screenshot validation
                </div>
                
                <div id="step1-preview"></div>
            </div>

            <!-- Step 2: Message Detection -->
            <div class="step-card">
                <div class="step-title">
                    <div class="step-number">2</div>
                    Message Detection Module
                    <span id="step2-status" class="status-indicator status-pending">Ready</span>
                </div>
                
                <button id="analyze-cards-opencv" class="test-button">
                    Step 1: üì¶ Find Message Card Boundaries (Card-First Detection)
                </button>
                
                <button id="test-username-extraction" class="test-button">
                    Step 2: üî§ Username Extraction + Early Filter
                </button>
                
                <button id="extract-message-cards" class="test-button">
                    Step 3: üìã Complete Message Cards
                </button>
                
                <button id="test-card-boundaries" class="test-button">
                    Step 3.5: üî≤ Card Boundary Detection
                </button>
                
                <button id="test-contact-name-boundary" class="test-button">
                    Section 5: üìù Contact Name Boundary Detector
                </button>
                
                <button id="test-timestamp-detection" class="test-button">
                    ‚è∞ Timestamp Boundary Detection
                </button>
                
                <button id="test-click" class="test-button" disabled style="background: #ccc;">
                    Step 4: üñ±Ô∏è Test Click at Coordinates
                </button>
                
                <!-- Legacy Methods Section -->
                <div class="legacy-methods">
                    <button class="legacy-toggle" onclick="toggleLegacyMethods()">
                        <span>üìÅ Legacy Detection Methods</span>
                        <span class="arrow">‚ñ∂</span>
                    </button>
                    <div class="legacy-content" id="legacy-content">
                        <p style="font-size: 0.8em; color: #666; margin-bottom: 10px;">
                            Historical methods for reference and comparison purposes
                        </p>
                        
                        <button id="test-detection" class="legacy-button">
                            üîç Test Message Detection (Old Method)
                        </button>
                        
                        <button id="analyze-contact-cards" class="legacy-button">
                            üìã Analyze Contact Cards (New Method)
                        </button>
                        
                        <button id="analyze-cards-improved" class="legacy-button">
                            üéØ Analyze Cards (Improved Avatar Detection)
                        </button>
                        
                        <button id="analyze-cards-robust" class="legacy-button">
                            üéØ Robust Avatar Detection (22 Avatars)
                        </button>
                        
                        <button id="analyze-cards-accurate" class="legacy-button">
                            ‚úÖ Accurate Detection (16 Real Avatars)
                        </button>
                    </div>
                </div>
                
                <div class="result-area" id="step2-result">
                    Click "Username Extraction + Early Filter" to test Step 2:
                    ‚Ä¢ Avatar detection with OpenCV adaptive thresholding
                    ‚Ä¢ Username OCR from small regions (500ms vs 5000ms)
                    ‚Ä¢ Early filtering against monitoring list (names.txt)
                    ‚Ä¢ Efficiency gain: Skip irrelevant contacts (saves 8+ seconds each)
                    ‚Ä¢ Visual verification with extraction confidence scores
                </div>
                
                <div id="step2-preview"></div>
            </div>
        </div>

        <!-- Module Test Card -->
        <div class="module-test-card">
            <div class="module-header">
                <div class="module-icon">üß©</div>
                <div class="module-title">
                    <h3>m_ScreenShot_WeChatWindow Module Tests</h3>
                    <p>Test the isolated screenshot module functions directly</p>
                </div>
                <div class="module-badge">Module</div>
            </div>
            
            <div class="module-functions">
                <div class="function-test">
                    <button id="test-capture-messages" class="module-test-button">
                        üîÑ Test capture_messages_screenshot()
                    </button>
                    <div class="function-description">
                        Backward compatibility function with parameters: save_dir, region, prefix, use_dynamic_detection
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-capture-screenshot" class="module-test-button">
                        üì∏ Test capture_screenshot()
                    </button>
                    <div class="function-description">
                        Clean API function with parameters: output_dir, filename, detect_window
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-class-direct" class="module-test-button">
                        üèóÔ∏è Test WeChatScreenshotCapture Class
                    </button>
                    <div class="function-description">
                        Direct class usage: instantiation, window detection, screenshot capture
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-all-functions" class="module-test-button comprehensive">
                        ‚öôÔ∏è Comprehensive Test (All Functions)
                    </button>
                    <div class="function-description">
                        Test all three functions sequentially with performance comparison
                    </div>
                </div>
            </div>
            
            <div class="module-results" id="module-results">
                <div class="results-header">üìä Module Test Results</div>
                <div class="results-content">
                    Click any test button above to see detailed results for each function...
                </div>
            </div>
        </div>

        <!-- NEW: Screenshot Processing Diagnostics (CLAUDE.md Compliance) -->
        <div class="module-test-card">
            <div class="module-header">
                <div class="module-icon">üöÄ</div>
                <div class="module-title">
                    <h3>Screenshot Processing Diagnostics</h3>
                    <p>Test single-screenshot architecture, performance metrics, and validation systems</p>
                </div>
                <div class="module-badge">New</div>
            </div>
            
            <div class="module-functions">
                <div class="function-test">
                    <button id="test-single-screenshot-architecture" class="module-test-button">
                        üèóÔ∏è Test Single-Screenshot Architecture
                    </button>
                    <div class="function-description">
                        Test caching system, session management, and performance optimization (50-70% improvement)
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-screenshot-performance" class="module-test-button">
                        üìä Test Performance Benchmarks
                    </button>
                    <div class="function-description">
                        Compare traditional vs optimized approach with timing metrics and analysis results
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-screenshot-validation" class="module-test-button">
                        üîç Test Quality Validation
                    </button>
                    <div class="function-description">
                        Multi-level validation: file integrity, dimensions, format compliance, quality scoring
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="get-screenshot-cache-info" class="module-test-button">
                        üìà Get Cache Status
                    </button>
                    <div class="function-description">
                        Real-time cache information, session status, and system configuration details
                    </div>
                </div>
            </div>
            
            <div class="module-results" id="screenshot-diagnostics-results">
                <div class="results-header">üöÄ Screenshot Diagnostics Results</div>
                <div class="results-content">
                    Click any diagnostic test above to see detailed performance metrics and validation results...
                </div>
            </div>
        </div>

        <!-- OCR Zone Boundaries Test Card -->
        <div class="ocr-zone-test-card">
            <div class="module-header">
                <div class="module-icon">üìê</div>
                <div class="module-title">
                    <h3>OCR Zone Boundaries Module</h3>
                    <p>Test OCR zone definition for message card components</p>
                </div>
                <div class="module-badge">Step 2.5</div>
            </div>
            
            <div class="module-functions">
                <div class="function-test">
                    <button id="test-ocr-zones-basic" class="module-test-button">
                        üî≤ Basic Zone Definition Test
                    </button>
                    <div class="function-description">
                        Test OCR zone calculation with predefined message card coordinates
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-ocr-zones-screenshot" class="module-test-button">
                        üì∏ Screenshot + Zone Analysis
                    </button>
                    <div class="function-description">
                        Capture screenshot, detect avatars, and define OCR zones with visual overlay
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-ocr-zones-adaptive" class="module-test-button">
                        üîÑ Adaptive Sizing Test
                    </button>
                    <div class="function-description">
                        Compare adaptive vs fixed zone sizing with different card dimensions
                    </div>
                </div>
                
                <div class="function-test">
                    <button id="test-ocr-zones-comprehensive" class="module-test-button comprehensive">
                        ‚öôÔ∏è Full Pipeline Integration
                    </button>
                    <div class="function-description">
                        Complete workflow: Screenshot ‚Üí Avatar Detection ‚Üí OCR Zone Definition
                    </div>
                </div>
            </div>
            
            <div class="module-results" id="ocr-zone-results">
                <div class="results-header">üìê OCR Zone Test Results</div>
                <div class="results-content">
                    Click any test button above to see OCR zone boundaries and visual verification...
                </div>
            </div>
        </div>

        <!-- Levels Adjustment Tool -->
        <div class="levels-tool">
            <h3>üìä Photoshop Levels Adjustment Tool</h3>
            <p>Adjust image levels using Photoshop-style controls</p>
            
            <div class="levels-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
                <!-- Left Column: Controls -->
                <div class="levels-controls">
                    <div class="control-section">
                        <h4>üìÅ Select Image</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <select id="imageSelector" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">Loading screenshots...</option>
                            </select>
                            <button onclick="refreshImageList()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">üîÑ Refresh</button>
                            <button onclick="loadSelectedImage()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">üì∏ Load</button>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h4>üåà Brightness & Contrast</h4>
                        <div class="slider-group">
                            <label for="brightnessSlider">Brightness (-100 to +100):</label>
                            <input type="range" id="brightnessSlider" min="-100" max="100" value="0" step="1">
                            <span id="brightnessValue">0</span>
                        </div>
                        
                        <div class="slider-group">
                            <label for="contrastSlider">Contrast (-100 to +100):</label>
                            <input type="range" id="contrastSlider" min="-100" max="100" value="0" step="1">
                            <span id="contrastValue">0</span>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <h4>üéöÔ∏è Level Adjustments</h4>
                        <div class="slider-group">
                            <label for="shadowSlider">Shadow Input (0-255):</label>
                            <input type="range" id="shadowSlider" min="0" max="255" value="33" step="1">
                            <span id="shadowValue">33</span>
                        </div>
                        
                        <div class="slider-group">
                            <label for="midtoneSlider">Midtone Input (0.1-9.9):</label>
                            <input type="range" id="midtoneSlider" min="0.1" max="9.9" value="1.1" step="0.01">
                            <span id="midtoneValue">1.10</span>
                        </div>
                        
                        <div class="slider-group">
                            <label for="highlightSlider">Highlight Input (0-255):</label>
                            <input type="range" id="highlightSlider" min="0" max="255" value="255" step="1">
                            <span id="highlightValue">255</span>
                        </div>
                        
                        <button onclick="previewLevels()" class="apply-button" style="background: linear-gradient(135deg, #17a2b8, #0c7b8a); margin-bottom: 10px;">üëÄ Live Preview</button>
                        <button onclick="saveLevels()" class="apply-button" style="background: linear-gradient(135deg, #28a745, #1e7e34);">üíæ Save Image</button>
                    </div>
                    
                    <div id="levelStatus" class="status-message">Select an image to get started</div>
                </div>
                
                <!-- Right Column: Image Preview -->
                <div class="image-preview-section">
                    <div class="image-container">
                        <h4>üì∏ Original Image</h4>
                        <img id="originalImage" class="image-preview" src="" style="display: none; max-width: 100%; height: auto; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                        <p id="originalStatus">Select a screenshot and click "üì∏ Load" to load an image</p>
                    </div>
                    
                    <div class="image-container">
                        <h4>üìä Processed Image</h4>
                        <img id="adjustedImage" class="image-preview" src="" style="display: none; max-width: 100%; height: auto; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0;">
                        <p id="adjustedStatus">Adjust sliders to see real-time preview</p>
                        <a id="downloadLink" style="display: none; color: #007bff; text-decoration: underline; cursor: pointer;">üíæ Download Processed Image</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined Test -->
        <div class="combined-test">
            <h3>üöÄ Combined Module Test</h3>
            <p>Test both modules working together in sequence</p>
            <button id="test-combined" class="combined-test-button">
                Run Full Test Sequence
            </button>
            <button id="visualize-regions" class="combined-test-button">
                üé® Visualize Detection Regions
            </button>
            <button id="visualize-contact-cards" class="combined-test-button">
                üìã Visualize Contact Cards
            </button>
            <button id="clear-logs" class="combined-test-button">
                Clear All Logs
            </button>
        </div>

        <!-- Activity Log -->
        <div class="log-area" id="activity-log">
            === Activity Log ===
            Ready for testing...
        </div>
    </div>

    <script>
        let logCount = 0;

        // Levels Adjustment Tool Functions
        function refreshImageList() {
            showLevelStatus('Refreshing screenshot list...', 'processing');
            
            fetch('/api/list-screenshots')
            .then(response => response.json())
            .then(data => {
                const selector = document.getElementById('imageSelector');
                selector.innerHTML = '';
                
                if (data.success && data.screenshots.length > 0) {
                    // Add default option
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select a screenshot...';
                    selector.appendChild(defaultOption);
                    
                    // Add screenshot options
                    data.screenshots.forEach(filename => {
                        const option = document.createElement('option');
                        option.value = filename;
                        option.textContent = filename;
                        selector.appendChild(option);
                    });
                    
                    showLevelStatus(`‚úÖ Found ${data.screenshots.length} screenshots available`, 'success');
                } else {
                    selector.innerHTML = '<option value="">No screenshots found</option>';
                    showLevelStatus('‚ùå No screenshots found in pic/screenshots/', 'error');
                }
            })
            .catch(error => {
                console.error('Error refreshing image list:', error);
                showLevelStatus('‚ùå Failed to refresh image list', 'error');
            });
        }

        function loadSelectedImage() {
            const selector = document.getElementById('imageSelector');
            const selectedImage = selector.value;
            
            if (!selectedImage) {
                showLevelStatus('Please select an image first', 'error');
                return;
            }
            
            showLevelStatus('Loading selected image...', 'processing');
            
            fetch(`/api/load-screenshot?filename=${encodeURIComponent(selectedImage)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update original image
                    document.getElementById('originalImage').src = data.image_path + '?t=' + Date.now();
                    document.getElementById('originalImage').style.display = 'block';
                    document.getElementById('originalStatus').textContent = `Loaded: ${selectedImage}`;
                    
                    // Clear adjusted image initially, then trigger preview
                    document.getElementById('adjustedImage').style.display = 'none';
                    document.getElementById('adjustedStatus').textContent = 'Adjust sliders to see real-time preview';
                    document.getElementById('downloadLink').style.display = 'none';
                    
                    showLevelStatus('‚úÖ Image loaded successfully', 'success');
                    
                    // Automatically generate initial preview
                    setTimeout(() => {
                        previewLevels();
                    }, 500);
                } else {
                    showLevelStatus(`‚ùå Failed to load image: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading image:', error);
                showLevelStatus('‚ùå Failed to load image', 'error');
            });
        }

        function applyLevels() {
            const selectedImage = document.getElementById('imageSelector').value;
            if (!selectedImage) {
                showLevelStatus('Please select and load an image first', 'error');
                return;
            }
            
            const shadowInput = document.getElementById('shadowSlider').value;
            const midtoneInput = document.getElementById('midtoneSlider').value;
            const highlightInput = document.getElementById('highlightSlider').value;
            
            showLevelStatus('Processing levels adjustment...', 'processing');
            
            const requestData = {
                filename: selectedImage,
                shadow_input: parseInt(shadowInput),
                midtone_input: parseFloat(midtoneInput),
                highlight_input: parseInt(highlightInput)
            };
            
            fetch('/api/test-levels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update processed image
                    if (data.adjusted_path) {
                        document.getElementById('adjustedImage').src = data.adjusted_path + '?t=' + Date.now();
                        document.getElementById('adjustedImage').style.display = 'block';
                        document.getElementById('adjustedStatus').textContent = 
                            `Processed (${data.processing_time}ms) - Black: ${data.parameters.input_black}, White: ${data.parameters.input_white}, Gamma: ${data.parameters.gamma}`;
                        
                        // Show download link
                        const downloadLink = document.getElementById('downloadLink');
                        downloadLink.href = data.adjusted_path;
                        downloadLink.download = data.adjusted_path.split('/').pop();
                        downloadLink.style.display = 'block';
                    }
                    
                    showLevelStatus(`‚úÖ Levels applied successfully in ${data.processing_time}ms`, 'success');
                } else {
                    showLevelStatus(`‚ùå Failed to apply levels: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error applying levels:', error);
                showLevelStatus('‚ùå Failed to apply levels', 'error');
            });
        }

        // Preview levels without saving (for real-time updates)
        function previewLevels() {
            const selectedImage = document.getElementById('imageSelector').value;
            if (!selectedImage) {
                showLevelStatus('Please select and load an image first', 'error');
                return;
            }
            
            const brightnessValue = document.getElementById('brightnessSlider').value;
            const contrastValue = document.getElementById('contrastSlider').value;
            const shadowInput = document.getElementById('shadowSlider').value;
            const midtoneInput = document.getElementById('midtoneSlider').value;
            const highlightInput = document.getElementById('highlightSlider').value;
            
            showLevelStatus('Generating preview...', 'processing');
            
            const requestData = {
                filename: selectedImage,
                brightness: parseInt(brightnessValue),
                contrast: parseInt(contrastValue),
                shadow_input: parseInt(shadowInput),
                midtone_input: parseFloat(midtoneInput),
                highlight_input: parseInt(highlightInput),
                preview_only: true  // Flag for preview mode
            };
            
            fetch('/api/preview-levels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update processed image with preview
                    if (data.preview_path) {
                        document.getElementById('adjustedImage').src = data.preview_path + '?t=' + Date.now();
                        document.getElementById('adjustedImage').style.display = 'block';
                        document.getElementById('adjustedStatus').textContent = 
                            `Preview (${data.processing_time}ms) - Brightness: ${brightnessValue}, Contrast: ${contrastValue}, Shadow: ${shadowInput}, Midtone: ${midtoneInput}, Highlight: ${highlightInput}`;
                        
                        // Hide download link for preview (no permanent file)
                        document.getElementById('downloadLink').style.display = 'none';
                    }
                    
                    showLevelStatus(`üëÅÔ∏è Preview updated (${data.processing_time}ms)`, 'success');
                } else {
                    showLevelStatus(`‚ùå Preview failed: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error generating preview:', error);
                showLevelStatus('‚ùå Failed to generate preview', 'error');
            });
        }

        // Save the current levels adjustment as a permanent file
        function saveLevels() {
            const selectedImage = document.getElementById('imageSelector').value;
            if (!selectedImage) {
                showLevelStatus('Please select and load an image first', 'error');
                return;
            }
            
            const shadowInput = document.getElementById('shadowSlider').value;
            const midtoneInput = document.getElementById('midtoneSlider').value;
            const highlightInput = document.getElementById('highlightSlider').value;
            
            showLevelStatus('Saving processed image...', 'processing');
            
            const requestData = {
                filename: selectedImage,
                shadow_input: parseInt(shadowInput),
                midtone_input: parseFloat(midtoneInput),
                highlight_input: parseInt(highlightInput),
                save_output: true  // Flag for save mode
            };
            
            fetch('/api/test-levels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update processed image with saved version
                    if (data.adjusted_path) {
                        document.getElementById('adjustedImage').src = data.adjusted_path + '?t=' + Date.now();
                        document.getElementById('adjustedImage').style.display = 'block';
                        document.getElementById('adjustedStatus').textContent = 
                            `üíæ Saved (${data.processing_time}ms) - Black: ${data.parameters.input_black}, White: ${data.parameters.input_white}, Gamma: ${data.parameters.gamma}`;
                        
                        // Show download link for saved file
                        const downloadLink = document.getElementById('downloadLink');
                        downloadLink.href = data.adjusted_path;
                        downloadLink.download = data.adjusted_path.split('/').pop();
                        downloadLink.style.display = 'block';
                    }
                    
                    showLevelStatus(`‚úÖ Image saved successfully in ${data.processing_time}ms`, 'success');
                } else {
                    showLevelStatus(`‚ùå Failed to save: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving image:', error);
                showLevelStatus('‚ùå Failed to save image', 'error');
            });
        }

        function showLevelStatus(message, type) {
            const status = document.getElementById('levelStatus');
            status.textContent = message;
            status.className = 'status-message';
            
            if (type === 'error') {
                status.style.background = 'rgba(255, 0, 0, 0.3)';
            } else if (type === 'success') {
                status.style.background = 'rgba(0, 255, 0, 0.3)';
            } else if (type === 'processing') {
                status.style.background = 'rgba(255, 255, 0, 0.3)';
            } else {
                status.style.background = 'rgba(255, 255, 255, 0.1)';
            }
        }

        // Update slider values in real time and trigger preview
        let previewTimer = null;
        
        function updateSliderValues() {
            document.getElementById('brightnessSlider').addEventListener('input', function() {
                document.getElementById('brightnessValue').textContent = this.value;
                triggerPreviewUpdate();
            });
            
            document.getElementById('contrastSlider').addEventListener('input', function() {
                document.getElementById('contrastValue').textContent = this.value;
                triggerPreviewUpdate();
            });
            
            document.getElementById('shadowSlider').addEventListener('input', function() {
                document.getElementById('shadowValue').textContent = this.value;
                triggerPreviewUpdate();
            });
            
            document.getElementById('midtoneSlider').addEventListener('input', function() {
                document.getElementById('midtoneValue').textContent = parseFloat(this.value).toFixed(2);
                triggerPreviewUpdate();
            });
            
            document.getElementById('highlightSlider').addEventListener('input', function() {
                document.getElementById('highlightValue').textContent = this.value;
                triggerPreviewUpdate();
            });
        }
        
        function triggerPreviewUpdate() {
            // Clear existing timer to avoid multiple rapid calls
            if (previewTimer) {
                clearTimeout(previewTimer);
            }
            
            // Only trigger preview if an image is loaded
            const selectedImage = document.getElementById('imageSelector').value;
            const originalImage = document.getElementById('originalImage');
            
            if (selectedImage && originalImage.style.display !== 'none') {
                // Debounce: wait 300ms after last slider change before updating preview
                previewTimer = setTimeout(() => {
                    previewLevels();
                }, 300);
            }
        }

        // Initialize levels tool on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshImageList();
            updateSliderValues();
        });

        function toggleLegacyMethods() {
            const content = document.getElementById('legacy-content');
            const toggle = document.querySelector('.legacy-toggle');
            const arrow = toggle.querySelector('.arrow');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
                arrow.textContent = '‚ñ∂';
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
                arrow.textContent = '‚ñº';
            }
        }

        function log(message, type = 'info') {
            const logArea = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : 'üìù';
            const className = type === 'error' ? 'error-message' : type === 'success' ? 'success-message' : '';
            
            logArea.innerHTML += `\n<span class="${className}">[${timestamp}] ${prefix} ${message}</span>`;
            logArea.scrollTop = logArea.scrollHeight;
            logCount++;
        }

        function updateStatus(stepId, status, text) {
            const statusEl = document.getElementById(`${stepId}-status`);
            statusEl.className = `status-indicator status-${status}`;
            statusEl.textContent = text;
        }

        function setResult(stepId, content) {
            document.getElementById(`${stepId}-result`).textContent = content;
        }

        function addPreview(stepId, content) {
            document.getElementById(`${stepId}-preview`).innerHTML = content;
        }

        // Step 1: Screenshot Capture Test
        document.getElementById('test-screenshot').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing...';
            
            updateStatus('step1', 'running', 'Testing...');
            log('Starting Step 1: Screenshot Capture Test');
            
            try {
                const response = await fetch('/api/test-screenshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('step1', 'success', 'Passed');
                    
                    // Build enhanced visual result
                    let resultText = `<span class="success-message">üì∏ Screenshot Capture Success!</span><br><br>`;
                    
                    // KEY OUTPUT: Screenshot Information
                    resultText += `<div class="step-output-card">`;
                    resultText += `<div class="step-output-title">üì∏ KEY OUTPUT: Screenshot Captured</div>`;
                    resultText += `<div style="font-size: 1.1em; font-weight: bold; color: #28a745;">`;
                    resultText += `WeChat Window Successfully Captured`;
                    resultText += `</div>`;
                    resultText += `<div class="coordinates-highlight">`;
                    resultText += `Window Bounds: ${result.window_coords.join(' x ')} pixels`;
                    resultText += `</div>`;
                    resultText += `<div style="margin-top: 10px;">`;
                    resultText += `‚Ä¢ File: ${result.screenshot_path.split('/').pop()}<br>`;
                    resultText += `‚Ä¢ Size: ${result.file_size}<br>`;
                    resultText += `‚Ä¢ Validation: ${result.validation_passed ? '‚úÖ Passed' : '‚ùå Failed'}<br>`;
                    resultText += `‚Ä¢ Capture Time: ${result.detection_time}ms`;
                    resultText += `</div>`;
                    resultText += `</div>`;

                    // Add method information
                    if (result.method_info) {
                        resultText += `

üîß Method Details:
Method Name: ${result.method_info.method_name}
Module Path: ${result.method_info.module_path}
Technique: ${result.method_info.technique}
Parameters: ${result.method_info.parameters}
Accuracy: ${result.method_info.accuracy}`;
                    }
                    
                    setResult('step1', resultText);

                    if (result.screenshot_url) {
                        addPreview('step1', `
                            <div class="coordinates-display">
                                <strong>Window Coordinates:</strong> (${result.window_coords.join(', ')})
                            </div>
                            <img src="${result.screenshot_url}" class="screenshot-preview" alt="Captured Screenshot">
                        `);
                    }
                    
                    log(`Screenshot captured successfully: ${result.screenshot_path}`, 'success');
                } else {
                    updateStatus('step1', 'error', 'Failed');
                    setResult('step1', `‚ùå Screenshot Capture Failed: ${result.error}`);
                    log(`Screenshot capture failed: ${result.error}`, 'error');
                }
            } catch (error) {
                updateStatus('step1', 'error', 'Error');
                setResult('step1', `‚ùå Network Error: ${error.message}`);
                log(`Step 1 network error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.textContent = 'üì∏ Test Screenshot Capture';
        });

        let detectedCoordinates = null;

        // Legacy Method: test-detection
        document.getElementById('test-detection').addEventListener('click', async function() {
            const button = this;
            const clickButton = document.getElementById('test-click');
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing...';
            
            updateStatus('step2', 'running', 'Testing...');
            log('Starting Legacy: Message Detection Test');
            
            try {
                const response = await fetch('/api/test-detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('step2', 'success', result.detected ? 'Detected' : 'No Messages');
                    
                    let resultText = `‚úÖ Legacy Message Detection Complete!
                    
Detection Method: ${result.method}
Message Detected: ${result.detected ? 'Yes' : 'No'}`;

                    if (result.detected) {
                        detectedCoordinates = result.coordinates;
                        resultText += `
Click Coordinates: (${result.coordinates.join(', ')})
Detection Confidence: ${result.confidence || 'High'}`;
                        
                        addPreview('step2', `
                            <div class="detection-result">
                                <strong>üéØ Message Found!</strong><br>
                                Method: ${result.method}<br>
                                Coordinates: (${result.coordinates.join(', ')})<br>
                                ${result.target_contact ? `Target: ${result.target_contact}` : ''}
                            </div>
                        `);
                        
                        // Enable click button
                        clickButton.disabled = false;
                        clickButton.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        clickButton.style.cursor = 'pointer';
                        
                    } else {
                        detectedCoordinates = null;
                        resultText += `
Analysis: ${result.analysis || 'No new messages in current screenshot'}`;
                        
                        // Disable click button
                        clickButton.disabled = true;
                        clickButton.style.background = '#ccc';
                        clickButton.style.cursor = 'not-allowed';
                    }
                    
                    resultText += `
Processing Time: ${result.processing_time}ms`;

                    // Add method information
                    if (result.method_info) {
                        resultText += `

üîß Method Details:
Method Name: ${result.method_info.method_name}
Module Path: ${result.method_info.module_path}
Technique: ${result.method_info.technique}
Parameters: ${result.method_info.parameters}
Accuracy: ${result.method_info.accuracy}`;
                    }
                    
                    setResult('step2', resultText);
                    log(`Legacy detection ${result.detected ? 'found message' : 'no messages'} using ${result.method}`, 'success');
                } else {
                    detectedCoordinates = null;
                    clickButton.disabled = true;
                    clickButton.style.background = '#ccc';
                    
                    updateStatus('step2', 'error', 'Failed');
                    setResult('step2', `‚ùå Legacy Detection Failed: ${result.error}`);
                    log(`Legacy detection failed: ${result.error}`, 'error');
                }
            } catch (error) {
                detectedCoordinates = null;
                clickButton.disabled = true;
                clickButton.style.background = '#ccc';
                
                updateStatus('step2', 'error', 'Error');
                setResult('step2', `‚ùå Network Error: ${error.message}`);
                log(`Legacy detection error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.textContent = 'üîç Test Message Detection (Old Method)';
        });

        // Legacy Method: analyze-contact-cards
        document.getElementById('analyze-contact-cards').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Analyzing Contact Cards...';
            
            updateStatus('step2', 'running', 'Analyzing...');
            
            log('üìã Starting legacy contact card analysis...');
            
            try {
                const response = await fetch('/api/analyze-contact-cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateStatus('step2', 'success', 'Complete');
                    
                    const summary = `‚úÖ Legacy Contact Card Analysis Results:
üìä Total Cards: ${result.total_cards}
üî¥ Cards with Red Dots: ${result.cards_with_notifications}
üí¨ Cards with Messages: ${result.cards_with_messages}
‚è±Ô∏è Processing Time: ${result.processing_time}ms
üì∑ Screenshot: ${result.screenshot_analyzed}`;

                    setResult('step2', summary);
                    
                    log(`‚úÖ Found ${result.total_cards} contact cards, ${result.cards_with_notifications} with notifications`, 'success');
                    
                    if (result.best_target) {
                        detectedCoordinates = result.best_target.coordinates;
                        document.getElementById('test-click').disabled = false;
                        document.getElementById('test-click').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                        
                        log(`üéØ Best target: "${result.best_target.contact_name}" at (${result.best_target.coordinates.join(', ')})`, 'success');
                    } else {
                        log('‚ö†Ô∏è  No valid click targets found', 'error');
                    }
                } else {
                    updateStatus('step2', 'error', 'Failed');
                    setResult('step2', `‚ùå Contact card analysis failed: ${result.error}`);
                    log(`‚ùå Contact card analysis error: ${result.error}`, 'error');
                }
                
            } catch (error) {
                updateStatus('step2', 'error', 'Error');
                setResult('step2', `‚ùå Network Error: ${error.message}`);
                log(`‚ùå Contact card analysis network error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üìã Analyze Contact Cards (New Method)';
        });

        // Simplified legacy handlers for remaining methods
        ['analyze-cards-improved', 'analyze-cards-robust', 'analyze-cards-accurate'].forEach(id => {
            document.getElementById(id).addEventListener('click', async function() {
                const button = this;
                button.disabled = true;
                button.innerHTML = '<span class="spinner"></span>Processing...';
                
                log(`Legacy method ${id} executed (API may not be available)`, 'info');
                
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = button.textContent || button.innerText;
                    setResult('step2', '‚ö†Ô∏è Legacy method - API endpoints may not be available');
                    log(`Legacy method ${id} completed`, 'info');
                }, 1000);
            });
        });

        // Step 2f: OpenCV Adaptive Detection
        document.getElementById('analyze-cards-opencv').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Card-First Detection...';
            
            try {
                const response = await fetch('/api/analyze-contact-cards-opencv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('step2', 'success', 'Success');
                    
                    let resultHtml = `<span class="success-message">üì¶ Card-First Detection Complete</span><br>`;
                    
                    // KEY OUTPUT: Card-First Detection Results
                    resultHtml += `<div class="step-output-card">`;
                    resultHtml += `<div class="step-output-title">üéØ KEY OUTPUT: Card-First Detection Results</div>`;
                    resultHtml += `<div style="font-size: 1.2em; font-weight: bold; color: #28a745;">`;
                    resultHtml += `${data.statistics.total_cards} Message Cards with Avatars Detected`;
                    resultHtml += `</div>`;
                    resultHtml += `<div style="margin-top: 10px;">`;
                    resultHtml += `‚Ä¢ Detection Method: Card Boundaries ‚Üí Avatar Within Cards<br>`;
                    resultHtml += `‚Ä¢ Processing Time: ${data.processing_time}ms<br>`;
                    resultHtml += `‚Ä¢ Screenshot: ${data.statistics.screenshot}`;
                    resultHtml += `</div>`;
                    resultHtml += `</div>`;
                    
                    // Display visualization image if available
                    if (data.visualization_filename) {
                        resultHtml += `<br><div class="image-container">`;
                        resultHtml += `<strong>üé® Visual Overlay:</strong><br>`;
                        // Add cache-busting timestamp to force browser reload
                        const cacheBuster = Date.now();
                        resultHtml += `<img src="/screenshot/${data.visualization_filename}?cb=${cacheBuster}" class="visualization-image" alt="OpenCV Detection Visualization" onclick="window.open(this.src, '_blank')">`;
                        resultHtml += `<br><a href="/screenshot/${data.visualization_filename}?cb=${cacheBuster}" class="download-link" download>üì• Download Visualization</a>`;
                        resultHtml += `</div>`;
                    }
                    
                    if (data.cards && data.cards.length > 0) {
                        resultHtml += `<br><strong>Detected Message Cards (First 10):</strong><br>`;
                        data.cards.slice(0, 10).forEach((card, idx) => {
                            resultHtml += `‚Ä¢ Card ${idx+1}: Avatar at (${card.click_position[0]}, ${card.click_position[1]}) | Card Size: ${card.card_bounds[2]}x${card.card_bounds[3]}<br>`;
                        });
                        
                        if (data.cards.length > 10) {
                            resultHtml += `‚Ä¢ ... and ${data.cards.length - 10} more avatars<br>`;
                        }
                        
                        // Store first card coordinates for click test
                        if (data.cards[0] && data.cards[0].click_center) {
                            detectedCoordinates = data.cards[0].click_center;
                            document.getElementById('test-click').disabled = false;
                            document.getElementById('test-click').style.background = '#2196f3';
                        }
                    } else if (data.statistics && data.statistics.message_cards_detected > 0) {
                        resultHtml += `<br><strong>üéØ Card-First Detection Results:</strong><br>`;
                        resultHtml += `‚Ä¢ Message cards detected: ${data.statistics.message_cards_detected}<br>`;
                        resultHtml += `‚Ä¢ Avatars found within cards: 0<br>`;
                        resultHtml += `‚Ä¢ Status: Card boundary detection successful, avatar detection needs refinement<br>`;
                        resultHtml += `‚Ä¢ Note: The visualization shows detected card boundaries in blue<br>`;
                    }
                    
                    resultHtml += `<br><strong>üì¶ Card-First Method:</strong><br>`;
                    resultHtml += `‚Ä¢ Step 1: Detect message card boundaries using edge detection<br>`;
                    resultHtml += `‚Ä¢ Step 2: Find avatars within each detected card<br>`;
                    resultHtml += `‚Ä¢ Step 3: Calculate username, timestamp, message regions<br>`;
                    resultHtml += `‚Ä¢ Color Legend: Blue=Card, Green=Avatar, Red=Click, Cyan=Username, Magenta=Time, Yellow=Message<br>`;
                    
                    // Add method information if available
                    if (data.method_info) {
                        resultHtml += `<br><strong>üîß Method Details:</strong><br>`;
                        resultHtml += `‚Ä¢ Method Name: ${data.method_info.method_name}<br>`;
                        resultHtml += `‚Ä¢ Module Path: ${data.method_info.module_path}<br>`;
                        resultHtml += `‚Ä¢ Technique: ${data.method_info.technique}<br>`;
                        resultHtml += `‚Ä¢ Parameters: ${data.method_info.parameters}<br>`;
                        resultHtml += `‚Ä¢ Accuracy: ${data.method_info.accuracy}<br>`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = resultHtml;
                    log('‚úÖ Card-first detection completed successfully', 'success');
                } else {
                    updateStatus('step2', 'error', 'Failed');
                    
                    let errorHtml = `<span class="error-message">‚ùå Card-First Detection Failed</span><br>Error: ${data.error}`;
                    
                    // Still show visualization if available even on failure
                    if (data.visualization_filename) {
                        errorHtml += `<br><div class="image-container">`;
                        errorHtml += `<strong>üé® Visual Analysis:</strong><br>`;
                        // Add cache-busting timestamp to force browser reload
                        const cacheBuster = Date.now();
                        errorHtml += `<img src="/screenshot/${data.visualization_filename}?cb=${cacheBuster}" class="visualization-image" alt="OpenCV Analysis Visualization" onclick="window.open(this.src, '_blank')">`;
                        errorHtml += `<br><a href="/screenshot/${data.visualization_filename}?cb=${cacheBuster}" class="download-link" download>üì• Download Visualization</a>`;
                        errorHtml += `</div>`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = errorHtml;
                    log(`‚ùå OpenCV detection failed: ${data.error}`, 'error');
                }
                
            } catch (error) {
                updateStatus('step2', 'error', 'Failed');
                document.getElementById('step2-result').innerHTML = 
                    `<span class="error-message">‚ùå OpenCV Detection Error</span><br>Error: ${error.message}`;
                log(`‚ùå OpenCV detection network error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üîç OpenCV Avatar Detection';
        });

        // Step 2b: Username Extraction Test
        document.getElementById('test-username-extraction').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing Username Extraction...';
            
            try {
                const response = await fetch('/api/test-username-extraction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                // Debug: Check response status and content type
                console.log('Response status:', response.status);
                console.log('Response content-type:', response.headers.get('content-type'));
                
                if (!response.ok) {
                    const text = await response.text();
                    console.log('Error response body:', text);
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('step2', 'success', 'Success');
                    
                    // Create enhanced visual output
                    let resultHtml = `<span class="success-message">üî§ Username Extraction + Early Filtering Complete</span><br>`;
                    
                    // Process Flow Visualization
                    resultHtml += `<div class="process-flow">`;
                    resultHtml += `<div class="process-step">`;
                    resultHtml += `<div style="font-size: 2em;">üîç</div>`;
                    resultHtml += `<div><strong>Step 1</strong><br>Detect Avatars<br><span style="color: #4a90e2; font-weight: bold;">${data.statistics.total_avatars} Found</span></div>`;
                    resultHtml += `</div>`;
                    resultHtml += `<div class="process-arrow">‚Üí</div>`;
                    resultHtml += `<div class="process-step">`;
                    resultHtml += `<div style="font-size: 2em;">üî§</div>`;
                    resultHtml += `<div><strong>Step 2</strong><br>Extract Usernames<br><span style="color: #4a90e2; font-weight: bold;">${data.statistics.successful_extractions} Extracted</span></div>`;
                    resultHtml += `</div>`;
                    resultHtml += `<div class="process-arrow">‚Üí</div>`;
                    resultHtml += `<div class="process-step">`;
                    resultHtml += `<div style="font-size: 2em;">üéØ</div>`;
                    resultHtml += `<div><strong>Step 3</strong><br>Early Filter<br><span style="color: #28a745; font-weight: bold;">${data.statistics.relevant_contacts} Relevant</span></div>`;
                    resultHtml += `</div>`;
                    resultHtml += `</div>`;
                    
                    // Efficiency Metrics
                    if (data.statistics.filtered_out > 0) {
                        const timeSaved = data.statistics.filtered_out * 8000; // 8 seconds per filtered contact
                        resultHtml += `<div class="efficiency-metrics">`;
                        resultHtml += `<strong>‚ö° Efficiency Gains:</strong><br>`;
                        resultHtml += `‚Ä¢ Filtered out ${data.statistics.filtered_out} irrelevant contacts<br>`;
                        resultHtml += `‚Ä¢ Estimated time saved: ~${(timeSaved/1000).toFixed(1)} seconds<br>`;
                        resultHtml += `‚Ä¢ Processing time: ${data.processing_time}ms (vs ~${timeSaved + data.processing_time}ms without filtering)<br>`;
                        resultHtml += `‚Ä¢ Efficiency improvement: ${((timeSaved / (timeSaved + data.processing_time)) * 100).toFixed(1)}%`;
                        resultHtml += `</div>`;
                    }
                    
                    // KEY OUTPUT: Relevant Contacts
                    if (data.relevant_contacts && data.relevant_contacts.length > 0) {
                        resultHtml += `<div class="step-output-card">`;
                        resultHtml += `<div class="step-output-title">üéØ KEY OUTPUT: Contacts to Process</div>`;
                        
                        data.relevant_contacts.forEach((contact, index) => {
                            resultHtml += `<div class="contact-card contact-relevant">`;
                            resultHtml += `<strong>Contact #${index + 1}: ${contact.username}</strong><br>`;
                            resultHtml += `Confidence: ${contact.confidence.toFixed(2)}<br>`;
                            resultHtml += `<div class="coordinates-highlight">`;
                            resultHtml += `CLICK TARGET: (${contact.click_center[0]}, ${contact.click_center[1]})`;
                            resultHtml += `</div>`;
                            resultHtml += `</div>`;
                        });
                        
                        resultHtml += `</div>`;
                        
                        // Enable click test with first relevant contact
                        if (data.relevant_contacts.length > 0) {
                            detectedCoordinates = data.relevant_contacts[0].click_center;
                            document.getElementById('test-click').disabled = false;
                            document.getElementById('test-click').style.background = '#2196f3';
                        }
                    } else {
                        resultHtml += `<div class="step-output-card">`;
                        resultHtml += `<div class="step-output-title" style="background: #dc3545;">‚ùå KEY OUTPUT: No Relevant Contacts</div>`;
                        resultHtml += `<div>No contacts found in monitoring list. All ${data.statistics.total_avatars} contacts were filtered out.</div>`;
                        resultHtml += `</div>`;
                    }
                    
                    // Show monitoring list
                    if (data.monitoring_list && data.monitoring_list.length > 0) {
                        resultHtml += `<div class="contact-card" style="background: #f0f8ff; border: 2px solid #4a90e2;">`;
                        resultHtml += `<strong>üìã Monitoring List (from names.txt file):</strong><br>`;
                        resultHtml += `<div style="font-family: monospace; color: #666;">${data.monitoring_list.join(', ')}</div>`;
                        resultHtml += `<div style="margin-top: 5px; font-size: 0.9em; color: #888;">${data.monitoring_list.length} names loaded from root/names.txt</div>`;
                        resultHtml += `</div>`;
                    } else {
                        resultHtml += `<div class="contact-card" style="background: #fff3cd; border: 2px solid #ffc107;">`;
                        resultHtml += `<strong>‚ö†Ô∏è Monitoring List:</strong><br>`;
                        resultHtml += `<div style="color: #856404;">names.txt file not found or empty in root directory</div>`;
                        resultHtml += `</div>`;
                    }
                    
                    // Show filtered contacts
                    if (data.filtered_contacts && data.filtered_contacts.length > 0) {
                        resultHtml += `<details style="margin: 15px 0;">`;
                        resultHtml += `<summary style="cursor: pointer; font-weight: bold; color: #666;">üö´ Filtered Out Contacts (${data.filtered_contacts.length}) - Click to expand</summary>`;
                        resultHtml += `<div style="margin-top: 10px;">`;
                        
                        data.filtered_contacts.slice(0, 8).forEach((contact, index) => {
                            const cardClass = contact.reason === 'extraction_failed' ? 'contact-failed' : 'contact-filtered';
                            const reasonText = contact.reason === 'extraction_failed' ? 'OCR Failed' : 'Not in Monitoring List';
                            const reasonIcon = contact.reason === 'extraction_failed' ? '‚ùå' : '‚ö†Ô∏è';
                            
                            resultHtml += `<div class="contact-card ${cardClass}">`;
                            resultHtml += `${reasonIcon} <strong>${contact.username}</strong> - ${reasonText}`;
                            if (contact.confidence) {
                                resultHtml += ` (confidence: ${contact.confidence.toFixed(2)})`;
                            }
                            resultHtml += `</div>`;
                        });
                        
                        if (data.filtered_contacts.length > 8) {
                            resultHtml += `<div style="text-align: center; color: #666; font-style: italic;">... and ${data.filtered_contacts.length - 8} more</div>`;
                        }
                        
                        resultHtml += `</div>`;
                        resultHtml += `</details>`;
                    }
                    
                    // Method details (collapsible)
                    if (data.method_info) {
                        resultHtml += `<details style="margin: 15px 0;">`;
                        resultHtml += `<summary style="cursor: pointer; font-weight: bold; color: #666;">üîß Technical Details - Click to expand</summary>`;
                        resultHtml += `<div class="contact-card" style="background: #f8f9fa; margin-top: 10px;">`;
                        resultHtml += `<strong>Method:</strong> ${data.method_info.method_name}<br>`;
                        resultHtml += `<strong>Module:</strong> ${data.method_info.module_path}<br>`;
                        resultHtml += `<strong>Technique:</strong> ${data.method_info.technique}<br>`;
                        resultHtml += `<strong>Parameters:</strong> ${data.method_info.parameters}<br>`;
                        resultHtml += `<strong>Accuracy:</strong> ${data.method_info.accuracy}`;
                        resultHtml += `</div>`;
                        resultHtml += `</details>`;
                    }
                    
                    // Display visualization image
                    if (data.visualization_filename) {
                        resultHtml += `<div class="image-container">`;
                        resultHtml += `<strong>üé® Visual Verification:</strong><br>`;
                        resultHtml += `<img src="/screenshot/${data.visualization_filename}" class="visualization-image" alt="Username Extraction Visualization" onclick="window.open(this.src, '_blank')">`;
                        resultHtml += `<br><a href="/screenshot/${data.visualization_filename}" class="download-link" download>üì• Download Full Resolution</a>`;
                        resultHtml += `</div>`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = resultHtml;
                    log(`‚úÖ Username extraction: ${data.statistics.relevant_contacts}/${data.statistics.total_avatars} relevant contacts found`, 'success');
                } else {
                    updateStatus('step2', 'error', 'Failed');
                    
                    let errorHtml = `<span class="error-message">‚ùå Username Extraction Failed</span><br>Error: ${data.error}`;
                    document.getElementById('step2-result').innerHTML = errorHtml;
                    log(`‚ùå Username extraction failed: ${data.error}`, 'error');
                }
                
            } catch (error) {
                updateStatus('step2', 'error', 'Failed');
                document.getElementById('step2-result').innerHTML = 
                    `<span class="error-message">‚ùå Username Extraction Error</span><br>Error: ${error.message}`;
                log(`‚ùå Username extraction network error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üî§ Username Extraction + Early Filter';
        });

        // Step 2c: Complete Message Card Extraction
        document.getElementById('extract-message-cards').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Extracting Cards...';
            
            updateStatus('step2', 'running', 'Extracting message cards...');
            
            try {
                const response = await fetch('/api/extract-message-cards', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Message card extraction successful!', 'success');
                    updateStatus('step2', 'success', 'Success');
                    
                    // Create enhanced visual output
                    let resultHtml = `<span class="success-message">üìã Complete Message Card Extraction</span><br>`;
                    
                    // Statistics
                    const stats = data.statistics;
                    resultHtml += `<div class="stats-grid">`;
                    resultHtml += `<div class="stat-item"><strong>üìä Total Cards:</strong> ${stats.total_cards}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üïí With Timestamps:</strong> ${stats.cards_with_timestamps}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üí¨ With Previews:</strong> ${stats.cards_with_previews}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üî• High Priority:</strong> ${stats.high_priority_cards}</div>`;
                    resultHtml += `<div class="stat-item"><strong>‚è±Ô∏è Processing:</strong> ${stats.processing_time_ms}ms</div>`;
                    resultHtml += `</div><br>`;
                    
                    // Message Cards Display
                    resultHtml += `<div class="message-cards-container">`;
                    resultHtml += `<h4>üìã Message Cards (Numbered):</h4>`;
                    
                    data.message_cards.forEach(card => {
                        const priorityClass = card.card_priority <= 3 ? 'high-priority' : 'normal-priority';
                        const redDotIcon = card.has_red_dot ? ' üî¥' : '';
                        
                        resultHtml += `<div class="message-card ${priorityClass}">`;
                        resultHtml += `<div class="card-header">`;
                        resultHtml += `<span class="card-number">#${card.card_number}</span>`;
                        resultHtml += `<span class="card-priority">Priority: ${card.card_priority}</span>`;
                        resultHtml += `${redDotIcon}`;
                        resultHtml += `</div>`;
                        
                        resultHtml += `<div class="card-content">`;
                        resultHtml += `<div class="card-field"><strong>üë§ Username:</strong> ${card.username} <span class="confidence">(${(card.username_confidence || 0).toFixed(2)})</span></div>`;
                        resultHtml += `<div class="card-field"><strong>üïí Timestamp:</strong> ${card.timestamp} <span class="confidence">(${(card.timestamp_confidence || 0).toFixed(2)})</span></div>`;
                        resultHtml += `<div class="card-field"><strong>üí¨ Preview:</strong> ${card.message_preview} <span class="confidence">(${(card.message_confidence || 0).toFixed(2)})</span></div>`;
                        resultHtml += `<div class="card-field"><strong>üìç Click:</strong> ${JSON.stringify(card.click_coordinates)}</div>`;
                        resultHtml += `</div>`;
                        resultHtml += `</div>`;
                    });
                    
                    resultHtml += `</div><br>`;
                    
                    // Method Information
                    const method = data.method_info;
                    resultHtml += `<div class="method-info">`;
                    resultHtml += `<h4>üîß Method Details:</h4>`;
                    resultHtml += `<div><strong>Method:</strong> ${method.method_name}</div>`;
                    resultHtml += `<div><strong>Module:</strong> ${method.module_path}</div>`;
                    resultHtml += `<div><strong>Technique:</strong> ${method.technique}</div>`;
                    resultHtml += `<div><strong>Parameters:</strong> ${method.parameters}</div>`;
                    resultHtml += `<div><strong>Features:</strong> ${method.features}</div>`;
                    resultHtml += `</div><br>`;
                    
                    // Visualization
                    if (data.visualization_file) {
                        resultHtml += `<div class="visualization">`;
                        resultHtml += `<h4>üé® Visual Analysis:</h4>`;
                        resultHtml += `<img src="/screenshot/${data.visualization_file}" alt="Message Cards Visualization" style="max-width: 100%; border: 1px solid #ddd; border-radius: 8px;">`;
                        resultHtml += `<p><a href="/screenshot/${data.visualization_file}" target="_blank">üì∑ View Full Size</a></p>`;
                        resultHtml += `</div>`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = resultHtml;
                    
                    log(`üìã Extracted ${data.message_cards.length} message cards with complete information`, 'info');
                    
                } else {
                    log(`‚ùå Message card extraction failed: ${data.error}`, 'error');
                    updateStatus('step2', 'error', data.error);
                    document.getElementById('step2-result').innerHTML = `<span class="error-message">Error: ${data.error}</span>`;
                }
                
            } catch (error) {
                log(`‚ùå Message card extraction error: ${error.message}`, 'error');
                updateStatus('step2', 'error', 'Network error');
                document.getElementById('step2-result').innerHTML = `<span class="error-message">Network Error: ${error.message}</span>`;
            }
            
            button.disabled = false;
            button.innerHTML = 'üìã Complete Message Cards';
        });

        // Step 3.5: Card Boundary Detection
        document.getElementById('test-card-boundaries').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Detecting Boundaries...';
            
            updateStatus('step2', 'running', 'Detecting card boundaries...');
            
            try {
                const response = await fetch('/api/test-card-boundaries', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Card boundary detection successful!', 'success');
                    updateStatus('step2', 'success', 'Success');
                    
                    // Create visual output
                    let resultHtml = `<span class="success-message">üî≤ Card Boundary Detection</span><br>`;
                    
                    // Statistics
                    const stats = data.statistics;
                    resultHtml += `<div class="stats-grid">`;
                    resultHtml += `<div class="stat-item"><strong>üìä Total Cards:</strong> ${data.total_cards}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üìè Avg Height:</strong> ${Math.round(stats.avg_card_height)}px</div>`;
                    resultHtml += `<div class="stat-item"><strong>üìê Avg Width:</strong> ${Math.round(stats.avg_card_width)}px</div>`;
                    resultHtml += `<div class="stat-item"><strong>üéØ Methods:</strong> ${stats.detection_methods.join(', ')}</div>`;
                    resultHtml += `<div class="stat-item"><strong>‚è±Ô∏è Processing:</strong> ${stats.processing_time_ms}ms</div>`;
                    resultHtml += `</div><br>`;
                    
                    // Display cards
                    if (data.cards && data.cards.length > 0) {
                        resultHtml += `<strong>Detected Cards:</strong><br>`;
                        resultHtml += '<div class="card-grid">';
                        data.cards.forEach(card => {
                            resultHtml += `
                                <div class="card-item">
                                    <strong>Card ${card.card_id}</strong><br>
                                    Boundaries: (${card.boundaries.left}, ${card.boundaries.top}) ‚Üí (${card.boundaries.right}, ${card.boundaries.bottom})<br>
                                    Size: ${card.dimensions.width} √ó ${card.dimensions.height}px<br>
                                    Confidence: ${(card.confidence * 100).toFixed(0)}%<br>
                                    Method: ${card.detection_method}
                                </div>
                            `;
                        });
                        resultHtml += '</div>';
                    }
                    
                    // Display overlay image
                    if (data.overlay_image) {
                        resultHtml += `<br><strong>Visualization:</strong><br>`;
                        resultHtml += `<img src="/overlay/${data.overlay_image}" class="overlay-image" alt="Card boundaries">`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = resultHtml;
                    
                    log(`üî≤ Detected ${data.total_cards} message card boundaries`, 'info');
                    
                } else {
                    log(`‚ùå Card boundary detection failed: ${data.error}`, 'error');
                    updateStatus('step2', 'error', data.error);
                    document.getElementById('step2-result').innerHTML = `<span class="error-message">Error: ${data.error}</span>`;
                }
                
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                updateStatus('step2', 'error', error.message);
                document.getElementById('step2-result').innerHTML = `<span class="error-message">API Error: ${error.message}</span>`;
            }
            
            button.disabled = false;
            button.innerHTML = 'Step 3.5: üî≤ Card Boundary Detection';
        });

        // Section 5: Contact Name Boundary Detector
        document.getElementById('test-contact-name-boundary').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing Contact Names...';
            
            updateStatus('step2', 'running', 'Testing Contact Name Boundary Detector...');
            
            try {
                const response = await fetch('/api/test-contact-name-boundary-detector', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Contact Name Boundary Detector test completed!', 'success');
                    updateStatus('step2', 'success', 'Success');
                    
                    // Create visual output
                    let resultHtml = `<span class="success-message">üìù Contact Name Boundary Detector (Section 5)</span><br>`;
                    
                    // Detection Results
                    const results = data.detection_results;
                    resultHtml += `<div class="stats-grid">`;
                    resultHtml += `<div class="stat-item"><strong>üìä Cards Processed:</strong> ${results.cards_processed}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üìù Names Detected:</strong> ${results.names_detected}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üìà Success Rate:</strong> ${results.success_rate}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üîß Method:</strong> ${results.detection_method}</div>`;
                    resultHtml += `<div class="stat-item"><strong>‚è±Ô∏è Processing:</strong> ${data.processing_time}ms</div>`;
                    resultHtml += `</div><br>`;
                    
                    // Technical Details
                    const tech = data.technical_details;
                    resultHtml += `<strong>üîß Technical Configuration:</strong><br>`;
                    resultHtml += `<div class="tech-details">`;
                    resultHtml += `<div><strong>Search Region:</strong> ${tech.search_region}</div>`;
                    resultHtml += `<div><strong>Margins:</strong> ${tech.margins}</div>`;
                    resultHtml += `<div><strong>White Threshold:</strong> ${tech.white_threshold}</div>`;
                    resultHtml += `<div><strong>Size Constraints:</strong> ${tech.size_constraints}</div>`;
                    resultHtml += `<div><strong>Morphology:</strong> ${tech.morphology}</div>`;
                    resultHtml += `<div><strong>Major Fix:</strong> ${tech.major_fix}</div>`;
                    resultHtml += `</div><br>`;
                    
                    // Summary Status
                    const summary = data.summary;
                    resultHtml += `<div class="summary-status">`;
                    resultHtml += `<strong>Status:</strong> ${summary.status}<br>`;
                    resultHtml += `<strong>Result:</strong> ${summary.message}<br>`;
                    resultHtml += `<strong>Recommendation:</strong> ${summary.recommendation}`;
                    resultHtml += `</div><br>`;
                    
                    // Card Details
                    if (data.card_details && data.card_details.length > 0) {
                        resultHtml += `<strong>üìã Per-Card Analysis:</strong><br>`;
                        resultHtml += '<div class="card-grid">';
                        data.card_details.forEach(card => {
                            const statusIcon = card.name_detected ? '‚úÖ' : '‚ùå';
                            resultHtml += `
                                <div class="card-item">
                                    <strong>${statusIcon} Card ${card.card_id}</strong><br>
                                    ${card.name_detected ? 
                                        `Name: ${card.bbox}<br>Confidence: ${card.confidence}<br>Method: ${card.method}` :
                                        `Reason: ${card.reason}`
                                    }
                                </div>
                            `;
                        });
                        resultHtml += '</div>';
                    }
                    
                    // Visualization
                    if (data.visualization) {
                        resultHtml += `<br><strong>üé® Visualization:</strong><br>`;
                        resultHtml += `<div class="image-container">`;
                        resultHtml += `<img src="/pic/screenshots/${data.visualization.filename}" class="visualization-image" alt="Contact Name Detection">`;
                        resultHtml += `<br><em>${data.visualization.description}</em>`;
                        resultHtml += `<a href="/pic/screenshots/${data.visualization.filename}" target="_blank" class="download-link">üì• View Full Size</a>`;
                        resultHtml += `</div>`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = resultHtml;
                    
                    log(`üìù Section 5 Test: ${results.names_detected}/${results.cards_processed} names detected (${results.success_rate})`, 'info');
                    
                } else {
                    log(`‚ùå Contact Name Boundary Detector test failed: ${data.error}`, 'error');
                    updateStatus('step2', 'error', data.error);
                    document.getElementById('step2-result').innerHTML = `<span class="error-message">Error: ${data.error}</span>`;
                }
                
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                updateStatus('step2', 'error', error.message);
                document.getElementById('step2-result').innerHTML = `<span class="error-message">API Error: ${error.message}</span>`;
            }
            
            button.disabled = false;
            button.innerHTML = 'Section 5: üìù Contact Name Boundary Detector';
        });

        // Timestamp Boundary Detection
        document.getElementById('test-timestamp-detection').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Detecting Timestamp...';
            
            updateStatus('step2', 'running', 'Testing Timestamp Boundary Detection...');
            
            try {
                const response = await fetch('/api/test-timestamp-detection', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('‚úÖ Timestamp boundary detection completed!', 'success');
                    updateStatus('step2', 'success', 'Success');
                    
                    // Create visual output
                    let resultHtml = `<span class="success-message">‚è∞ Timestamp Boundary Detection</span><br>`;
                    
                    // Detection Results
                    resultHtml += `<div class="stats-grid">`;
                    resultHtml += `<div class="stat-item"><strong>üìç Boundary X:</strong> ${data.boundary_x} pixels</div>`;
                    resultHtml += `<div class="stat-item"><strong>üéØ Confidence:</strong> ${data.confidence.toUpperCase()}</div>`;
                    resultHtml += `<div class="stat-item"><strong>üîß Method:</strong> ${data.method_used}</div>`;
                    resultHtml += `<div class="stat-item"><strong>‚è±Ô∏è Processing:</strong> ${data.processing_time}ms</div>`;
                    resultHtml += `<div class="stat-item"><strong>üì∏ Source:</strong> ${data.image_path.split('/').pop()}</div>`;
                    resultHtml += `</div><br>`;
                    
                    // Analysis Summary
                    if (data.analysis) {
                        resultHtml += `<strong>üìä Analysis Summary:</strong><br>`;
                        resultHtml += `<div class="analysis-details">`;
                        resultHtml += `<div><strong>Position:</strong> ${data.analysis.boundary_position}</div>`;
                        resultHtml += `<div><strong>Quality:</strong> ${data.analysis.detection_quality}</div>`;
                        resultHtml += `<div><strong>Recommendation:</strong> ${data.analysis.recommended_usage}</div>`;
                        resultHtml += `</div><br>`;
                    }
                    
                    // Technical Details
                    if (data.debug_details) {
                        resultHtml += `<strong>üîß Technical Details:</strong><br>`;
                        resultHtml += `<div class="tech-details">`;
                        
                        const gradientInfo = data.debug_details.gradient_method;
                        if (gradientInfo && gradientInfo.boundary_x) {
                            resultHtml += `<div><strong>Gradient Method:</strong> x=${gradientInfo.boundary_x} (${gradientInfo.candidates_count} candidates, std=${gradientInfo.std_dev?.toFixed(1) || 'N/A'})</div>`;
                        }
                        
                        const edgeInfo = data.debug_details.edge_method;
                        if (edgeInfo && edgeInfo.boundary_x) {
                            resultHtml += `<div><strong>Edge Method:</strong> x=${edgeInfo.boundary_x}</div>`;
                        }
                        
                        if (data.debug_details.method_agreement) {
                            resultHtml += `<div><strong>Methods Agreement:</strong> Yes</div>`;
                        } else if (data.debug_details.fallback_reason) {
                            resultHtml += `<div><strong>Fallback Reason:</strong> ${data.debug_details.fallback_reason}</div>`;
                        }
                        
                        resultHtml += `</div><br>`;
                    }
                    
                    // Visualization
                    if (data.debug_image) {
                        resultHtml += `<strong>üé® Debug Visualization:</strong><br>`;
                        resultHtml += `<div class="image-container">`;
                        resultHtml += `<img src="/pic/screenshots/${data.debug_image}" class="visualization-image" alt="Timestamp Boundary Detection">`;
                        resultHtml += `<br><em>Green line shows detected timestamp left boundary at x=${data.boundary_x}. Yellow rectangle shows search region.</em>`;
                        resultHtml += `<a href="/pic/screenshots/${data.debug_image}" target="_blank" class="download-link">üì• View Full Size</a>`;
                        resultHtml += `</div>`;
                    }
                    
                    document.getElementById('step2-result').innerHTML = resultHtml;
                    
                    log(`‚è∞ Timestamp Detection: x=${data.boundary_x} (${data.confidence} confidence via ${data.method_used})`, 'info');
                    log(data.message, 'info');
                    
                } else {
                    log(`‚ùå Timestamp detection failed: ${data.error}`, 'error');
                    updateStatus('step2', 'error', data.error);
                    document.getElementById('step2-result').innerHTML = `<span class="error-message">Error: ${data.error}</span>`;
                    
                    if (data.analysis) {
                        log(`üí° Suggested action: ${data.analysis.suggested_action}`, 'info');
                    }
                }
                
            } catch (error) {
                log(`‚ùå API Error: ${error.message}`, 'error');
                updateStatus('step2', 'error', error.message);
                document.getElementById('step2-result').innerHTML = `<span class="error-message">API Error: ${error.message}</span>`;
            }
            
            button.disabled = false;
            button.innerHTML = '‚è∞ Timestamp Boundary Detection';
        });

        // Step 2d: Click Test
        document.getElementById('test-click').addEventListener('click', async function() {
            if (!detectedCoordinates) {
                log('No coordinates available for clicking. Run detection first.', 'error');
                return;
            }
            
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Clicking...';
            
            log(`Attempting to click at coordinates: (${detectedCoordinates.join(', ')})`);
            
            try {
                const response = await fetch('/api/test-click', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coordinates: detectedCoordinates })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Click executed successfully at (${result.coordinates.join(', ')}) in ${result.click_time}ms`, 'success');
                    
                    addPreview('step2', `
                        <div class="detection-result">
                            <strong>üñ±Ô∏è Click Executed!</strong><br>
                            Coordinates: (${result.coordinates.join(', ')})<br>
                            Execution Time: ${result.click_time}ms<br>
                            Status: Success ‚úÖ
                        </div>
                    `);
                } else {
                    log(`‚ùå Click failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Click test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üñ±Ô∏è Test Click at Coordinates';
        });

        // Module Test Buttons
        
        // Test capture_messages_screenshot
        document.getElementById('test-capture-messages').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing capture_messages_screenshot...';
            
            log('Testing capture_messages_screenshot() function...');
            
            try {
                const response = await fetch('/api/test-module-capture-messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ capture_messages_screenshot() test completed in ${result.duration_ms}ms`, 'success');
                    displayModuleResults(result);
                } else {
                    log(`‚ùå capture_messages_screenshot() test failed: ${result.error}`, 'error');
                    displayModuleResults(result);
                }
            } catch (error) {
                log(`‚ùå Module test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üîÑ Test capture_messages_screenshot()';
        });

        // Test capture_screenshot
        document.getElementById('test-capture-screenshot').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing capture_screenshot...';
            
            log('Testing capture_screenshot() function...');
            
            try {
                const response = await fetch('/api/test-module-capture-screenshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ capture_screenshot() test completed in ${result.duration_ms}ms`, 'success');
                    displayModuleResults(result);
                } else {
                    log(`‚ùå capture_screenshot() test failed: ${result.error}`, 'error');
                    displayModuleResults(result);
                }
            } catch (error) {
                log(`‚ùå Module test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üì∏ Test capture_screenshot()';
        });

        // Test WeChatScreenshotCapture class
        document.getElementById('test-class-direct').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing WeChatScreenshotCapture...';
            
            log('Testing WeChatScreenshotCapture class directly...');
            
            try {
                const response = await fetch('/api/test-module-class-direct', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ WeChatScreenshotCapture class test completed in ${result.duration_ms}ms`, 'success');
                    displayModuleResults(result);
                } else {
                    log(`‚ùå WeChatScreenshotCapture class test failed: ${result.error}`, 'error');
                    displayModuleResults(result);
                }
            } catch (error) {
                log(`‚ùå Module test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üèóÔ∏è Test WeChatScreenshotCapture Class';
        });

        // Test all functions comprehensively
        document.getElementById('test-all-functions').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing All Functions...';
            
            log('Running comprehensive test of all module functions...');
            
            try {
                const response = await fetch('/api/test-module-all-functions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Comprehensive module test completed in ${result.duration_ms}ms`, 'success');
                    log(`üìä Results: ${result.summary.successful}/${result.summary.total_tests} functions passed`);
                    displayModuleResults(result);
                } else {
                    log(`‚ùå Comprehensive test failed: ${result.error}`, 'error');
                    displayModuleResults(result);
                }
            } catch (error) {
                log(`‚ùå Module test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = '‚öôÔ∏è Comprehensive Test (All Functions)';
        });

        // Function to display module test results
        function displayModuleResults(result) {
            const resultsContent = document.querySelector('#module-results .results-content');
            
            let html = `
                <div class="module-test-result">
                    <div class="test-header">
                        <h4>${result.function_name}</h4>
                        <span class="test-status ${result.success ? 'success' : 'error'}">
                            ${result.success ? '‚úÖ Success' : '‚ùå Failed'}
                        </span>
                        <span class="test-duration">${result.duration_ms}ms</span>
                    </div>
            `;
            
            if (result.error) {
                html += `<div class="error-details">Error: ${result.error}</div>`;
            }
            
            if (result.test_results) {
                if (result.function_name === 'All Module Functions') {
                    // Comprehensive test results
                    html += `
                        <div class="comprehensive-results">
                            <div class="summary">
                                Summary: ${result.summary.successful}/${result.summary.total_tests} tests passed
                            </div>
                            <div class="individual-results">
                    `;
                    
                    result.test_results.forEach(test => {
                        html += `
                            <div class="individual-test ${test.success ? 'success' : 'error'}">
                                <span class="function-name">${test.function}</span>
                                <span class="test-status">${test.success ? '‚úÖ' : '‚ùå'}</span>
                                ${test.error ? `<div class="error">Error: ${test.error}</div>` : ''}
                                ${test.coordinates ? `<div class="coords">Coordinates: ${test.coordinates.join(', ')}</div>` : ''}
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                } else {
                    // Single function test results
                    if (result.test_results.default_params) {
                        html += `
                            <div class="test-section">
                                <h5>Default Parameters</h5>
                                <div class="test-details ${result.test_results.default_params.success ? 'success' : 'error'}">
                                    Result: ${result.test_results.default_params.success ? '‚úÖ Success' : '‚ùå Failed'}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (result.test_results.custom_params) {
                        html += `
                            <div class="test-section">
                                <h5>Custom Parameters</h5>
                                <div class="test-details ${result.test_results.custom_params.success ? 'success' : 'error'}">
                                    Result: ${result.test_results.custom_params.success ? '‚úÖ Success' : '‚ùå Failed'}<br>
                                    Parameters: ${JSON.stringify(result.test_results.custom_params.parameters, null, 2)}
                                </div>
                            </div>
                        `;
                    }
                    
                    if (result.test_results.class_creation) {
                        html += `
                            <div class="test-section">
                                <h5>Class Operations</h5>
                                <div class="class-results">
                                    <div>Creation: ${result.test_results.class_creation.success ? '‚úÖ' : '‚ùå'}</div>
                                    <div>Window Detection: ${result.test_results.window_detection.success ? '‚úÖ' : '‚ùå'}</div>
                                    <div>Screenshot Capture: ${result.test_results.screenshot_capture.success ? '‚úÖ' : '‚ùå'}</div>
                                    ${result.test_results.window_detection.coordinates ? 
                                        `<div>Coordinates: ${result.test_results.window_detection.coordinates.join(', ')}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            if (result.screenshot_urls && result.screenshot_urls.length > 0) {
                html += `
                    <div class="screenshot-section">
                        <h5>Generated Screenshots</h5>
                        <div class="screenshot-gallery">
                `;
                
                result.screenshot_urls.forEach((url, index) => {
                    html += `
                        <div class="screenshot-item">
                            <img src="${url}?cb=${Date.now()}" alt="Screenshot ${index + 1}" 
                                 onclick="window.open(this.src, '_blank')" />
                            <div class="screenshot-label">Screenshot ${index + 1}</div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            html += '</div>';
            
            resultsContent.innerHTML = html;
        }

        // Combined Test
        document.getElementById('test-combined').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Running Combined Test...';
            
            log('=== Starting Combined Test Sequence ===');
            
            try {
                // Step 1: Screenshot Capture
                log('Step 1: Running screenshot capture...');
                await new Promise((resolve) => {
                    const screenshotBtn = document.getElementById('test-screenshot');
                    const originalHandler = screenshotBtn.onclick;
                    screenshotBtn.onclick = async function(e) {
                        await originalHandler.call(this, e);
                        resolve();
                    };
                    screenshotBtn.click();
                });
                
                // Wait for screenshot to complete
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Step 2a: OpenCV Message Detection
                log('Step 2a: Running OpenCV message detection...');
                let detectionResult = null;
                
                const detectionResponse = await fetch('/api/analyze-contact-cards-opencv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                detectionResult = await detectionResponse.json();
                
                if (detectionResult.success && detectionResult.cards && detectionResult.cards.length > 0) {
                    const firstCard = detectionResult.cards[0];
                    const clickCenterText = firstCard.click_center && Array.isArray(firstCard.click_center) 
                        ? firstCard.click_center.join(', ') 
                        : 'coordinates unavailable';
                    log(`‚úÖ OpenCV detected ${detectionResult.cards.length} avatars, first at (${clickCenterText})`, 'success');
                    
                    // Step 2b: Click on detected coordinates
                    log('Step 2b: Executing click at first detected avatar...');
                    
                    const clickResponse = await fetch('/api/test-click', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ coordinates: firstCard.click_center || [0, 0] })
                    });
                    
                    const clickResult = await clickResponse.json();
                    
                    if (clickResult.success) {
                        log(`‚úÖ Click executed successfully at (${clickResult.coordinates.join(', ')}) in ${clickResult.click_time}ms`, 'success');
                        log('=== Combined Test Sequence Complete - ALL STEPS PASSED ===', 'success');
                    } else {
                        log(`‚ùå Click failed: ${clickResult.error}`, 'error');
                        log('=== Combined Test Sequence Complete - CLICK FAILED ===', 'error');
                    }
                } else {
                    log('‚ö†Ô∏è No avatars detected by OpenCV - skipping click test', 'error');
                    log('=== Combined Test Sequence Complete - NO AVATARS TO CLICK ===', 'success');
                }
                
            } catch (error) {
                log(`‚ùå Combined test error: ${error.message}`, 'error');
                log('=== Combined Test Sequence Failed ===', 'error');
            }
            
            button.disabled = false;
            button.textContent = 'Run Full Test Sequence';
        });

        // Region Visualization
        document.getElementById('visualize-regions').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Creating Visualization...';
            
            log('üé® Creating detection region visualization...');
            
            try {
                const response = await fetch('/api/visualize-regions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Region visualization created: ${result.visualization_file}`, 'success');
                    log(`üìä Regions shown: Contact List (blue), Red Dot Search (red), Row Lines (green), Click Targets (yellow)`, 'info');
                    
                    // Show the visualization image
                    const previewHtml = `
                        <div class="detection-result">
                            <strong>üé® Detection Regions Visualization</strong><br>
                            Source: ${result.source_screenshot}<br>
                            Processing Time: ${result.processing_time}ms<br>
                            <hr style="margin: 10px 0;">
                            <img src="/screenshot/${result.visualization_file}" 
                                 alt="Detection Regions" 
                                 style="max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            <br><br>
                            <div style="font-size: 0.9em; color: #666;">
                                üìç <strong>Region Details:</strong><br>
                                ‚Ä¢ ${result.regions.contact_region}<br>
                                ‚Ä¢ ${result.regions.red_dot_region}<br>
                                ‚Ä¢ ${result.regions.contact_rows}<br>
                                ‚Ä¢ ${result.regions.click_targets}
                            </div>
                        </div>
                    `;
                    
                    // Display in step2 preview area for now
                    addPreview('step2', previewHtml);
                } else {
                    log(`‚ùå Region visualization failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Region visualization error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üé® Visualize Detection Regions';
        });

        // Contact Card Visualization
        document.getElementById('visualize-contact-cards').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Creating Contact Card Visualization...';
            
            log('üìã Creating contact card visualization...');
            
            try {
                const response = await fetch('/api/visualize-contact-cards', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Contact card visualization created: ${result.visualization_file}`, 'success');
                    log(`üìã Features: Individual cards, red borders (notifications), blue borders (messages), yellow dots (click positions)`, 'info');
                    
                    // Show the contact card visualization image
                    const previewHtml = `
                        <div class="detection-result">
                            <strong>üìã Contact Card Visualization</strong><br>
                            Source: ${result.source_screenshot}<br>
                            Processing Time: ${result.processing_time}ms<br>
                            <hr style="margin: 10px 0;">
                            <img src="/screenshot/${result.visualization_file}" 
                                 alt="Contact Cards" 
                                 style="max-width: 100%; height: auto; border-radius: 5px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            <br><br>
                            <div style="font-size: 0.9em; color: #666;">
                                üìç <strong>Contact Card Features:</strong><br>
                                ‚Ä¢ <span style="color: red;">Red Borders:</span> ${result.features.red_borders}<br>
                                ‚Ä¢ <span style="color: blue;">Blue Borders:</span> ${result.features.blue_borders}<br>
                                ‚Ä¢ <span style="color: green;">Green Borders:</span> ${result.features.green_borders}<br>
                                ‚Ä¢ <span style="color: orange;">Yellow Dots:</span> ${result.features.yellow_dots}<br>
                                ‚Ä¢ <span style="color: lightblue;">Light Blue Boxes:</span> ${result.features.light_blue_boxes}<br>
                            </div>
                        </div>
                    `;
                    
                    // Display in step2 preview area
                    addPreview('step2', previewHtml);
                } else {
                    log(`‚ùå Contact card visualization failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Contact card visualization error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üìã Visualize Contact Cards';
        });

        // ========== OCR Zone Test Event Handlers ==========
        
        // OCR Zones Basic Test
        document.getElementById('test-ocr-zones-basic').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing OCR Zones (Basic)...';
            
            log('üìê Running basic OCR zone definition test...');
            
            try {
                const response = await fetch('/api/test-ocr-zones-basic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ OCR zones basic test completed: ${result.enhanced_cards.length} cards processed`, 'success');
                    displayOCRZoneResults(result);
                } else {
                    log(`‚ùå OCR zones basic test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå OCR zones basic test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üî≤ Basic Zone Definition Test';
        });
        
        // OCR Zones Screenshot Test
        document.getElementById('test-ocr-zones-screenshot').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing OCR Zones (Screenshot)...';
            
            log('üìê Running OCR zone test with screenshot...');
            
            try {
                const response = await fetch('/api/test-ocr-zones-screenshot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ OCR zones screenshot test completed: ${result.enhanced_cards.length} cards processed`, 'success');
                    log(`üìä Avg confidence: ${result.statistics.avg_confidence.toFixed(2)} | Overlay: ${result.overlay_file || 'None'}`, 'info');
                    displayOCRZoneResults(result);
                } else {
                    log(`‚ùå OCR zones screenshot test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå OCR zones screenshot test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üì∏ Screenshot + Zone Analysis';
        });
        
        // OCR Zones Adaptive Test
        document.getElementById('test-ocr-zones-adaptive').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing OCR Zones (Adaptive)...';
            
            log('üìê Running OCR zone adaptive sizing test...');
            
            try {
                const response = await fetch('/api/test-ocr-zones-adaptive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ OCR zones adaptive test completed: ${result.adaptive_cards.length} cards processed`, 'success');
                    log(`üìä Adaptive vs Fixed confidence: ${result.comparison.adaptive_avg_confidence.toFixed(2)} vs ${result.comparison.fixed_avg_confidence.toFixed(2)}`, 'info');
                    displayOCRZoneResults(result);
                } else {
                    log(`‚ùå OCR zones adaptive test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå OCR zones adaptive test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üîÑ Adaptive Sizing Test';
        });
        
        // OCR Zones Comprehensive Test
        document.getElementById('test-ocr-zones-comprehensive').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing OCR Zones (Full Pipeline)...';
            
            log('üìê Running comprehensive OCR zone pipeline test...');
            
            try {
                const response = await fetch('/api/test-ocr-zones-comprehensive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Comprehensive OCR zones test completed: ${result.enhanced_cards.length} cards processed`, 'success');
                    log(`üìä Success rate: ${(result.statistics.success_rate * 100).toFixed(1)}% | Confidence: ${result.statistics.avg_confidence.toFixed(2)}`, 'success');
                    log(`üé® Overlay generated: ${result.overlay_file || 'None'}`, 'info');
                    displayOCRZoneResults(result);
                } else {
                    log(`‚ùå Comprehensive OCR zones test failed: ${result.error}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Comprehensive OCR zones test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = '‚öôÔ∏è Full Pipeline Integration';
        });
        
        // OCR Zone Results Display Function
        function displayOCRZoneResults(result) {
            const resultsContainer = document.getElementById('ocr-zone-results');
            const resultsContent = resultsContainer.querySelector('.results-content');
            
            let html = `
                <div class="test-header">
                    <h4>${result.method_info.method_name}</h4>
                    <span class="test-status ${result.success ? 'success' : 'error'}">
                        ${result.success ? 'SUCCESS' : 'FAILED'}
                    </span>
                    <span class="test-duration">${result.statistics.processing_time_ms || 0}ms</span>
                </div>
                
                <div class="test-section">
                    <h5>üìä Statistics</h5>
                    <div class="test-details">
                        Total Cards: ${result.statistics.total_cards || 0}<br>
            `;
            
            if (result.statistics.zones_defined !== undefined) {
                html += `Zones Defined: ${result.statistics.zones_defined}<br>`;
            }
            if (result.statistics.successful_zones !== undefined) {
                html += `Successful Zones: ${result.statistics.successful_zones}<br>`;
            }
            if (result.statistics.avg_confidence !== undefined) {
                html += `Average Confidence: ${result.statistics.avg_confidence.toFixed(3)}<br>`;
            }
            if (result.statistics.success_rate !== undefined) {
                html += `Success Rate: ${(result.statistics.success_rate * 100).toFixed(1)}%<br>`;
            }
            
            html += `    </div>
                </div>
            `;
            
            // Pipeline Summary (for comprehensive test)
            if (result.pipeline_summary) {
                html += `
                    <div class="test-section">
                        <h5>üîó Pipeline Summary</h5>
                        <div class="test-details">
                            ${Object.entries(result.pipeline_summary).map(([key, value]) => `${key}: ${value}`).join('<br>')}
                        </div>
                    </div>
                `;
            }
            
            // Zone Statistics (for comprehensive test)
            if (result.statistics.zone_statistics) {
                html += `
                    <div class="test-section">
                        <h5>üìê Zone Statistics</h5>
                        <div class="test-details">
                `;
                Object.entries(result.statistics.zone_statistics).forEach(([zone_type, stats]) => {
                    html += `<strong>${zone_type.replace('_', ' ')}:</strong> ${stats.defined_count} zones, avg ${stats.avg_width.toFixed(0)}x${stats.avg_height.toFixed(0)}px<br>`;
                });
                html += `        </div>
                    </div>
                `;
            }
            
            // Comparison Data (for adaptive test)
            if (result.comparison) {
                html += `
                    <div class="test-section">
                        <h5>üîÑ Adaptive vs Fixed Comparison</h5>
                        <div class="test-details">
                            Adaptive Confidence: ${result.comparison.adaptive_avg_confidence.toFixed(3)}<br>
                            Fixed Confidence: ${result.comparison.fixed_avg_confidence.toFixed(3)}<br>
                        </div>
                    </div>
                `;
            }
            
            // Method Information
            html += `
                <div class="test-section">
                    <h5>üîß Method Information</h5>
                    <div class="test-details">
                        Module: ${result.method_info.module_path}<br>
                        Technique: ${result.method_info.technique}<br>
                        Features: ${result.method_info.features}
                    </div>
                </div>
            `;
            
            // Screenshots and Overlays
            if (result.overlay_file || result.screenshot_file) {
                html += `
                    <div class="test-section">
                        <h5>üé® Visual Output</h5>
                        <div class="screenshot-gallery">
                `;
                
                if (result.screenshot_file) {
                    html += `
                        <div class="screenshot-item">
                            <img src="/screenshot/${result.screenshot_file}?cb=${Date.now()}" 
                                 alt="Original Screenshot" onclick="window.open(this.src, '_blank')" />
                            <div class="screenshot-label">Original Screenshot</div>
                        </div>
                    `;
                }
                
                if (result.overlay_file) {
                    html += `
                        <div class="screenshot-item">
                            <img src="/screenshot/${result.overlay_file}?cb=${Date.now()}" 
                                 alt="OCR Zones Overlay" onclick="window.open(this.src, '_blank')" />
                            <div class="screenshot-label">OCR Zones Overlay</div>
                        </div>
                    `;
                }
                
                html += `    </div>
                    </div>
                `;
            }
            
            resultsContent.innerHTML = html;
        }

        // Clear Logs
        document.getElementById('clear-logs').addEventListener('click', function() {
            document.getElementById('activity-log').innerHTML = '=== Activity Log ===\nLogs cleared...';
            logCount = 0;
            
            // Reset status indicators
            updateStatus('step1', 'pending', 'Ready');
            updateStatus('step2', 'pending', 'Ready');
            
            // Clear results
            setResult('step1', 'Click "Test Screenshot Capture" to verify:\n‚Ä¢ WeChat window detection\n‚Ä¢ Coordinate recording\n‚Ä¢ Precise screenshot capture\n‚Ä¢ Screenshot validation');
            setResult('step2', 'Click "OpenCV Message Detection" to analyze:\n‚Ä¢ Adaptive thresholding for lighting variations\n‚Ä¢ Avatar detection with aspect ratio filtering\n‚Ä¢ Size-based avatar validation (25-120px)\n‚Ä¢ Overlap removal with spacing validation\n‚Ä¢ Accurate click coordinate calculation');
            
            // Clear previews
            addPreview('step1', '');
            addPreview('step2', '');
        });

        // Auto-refresh logs every 5 seconds if there's activity
        setInterval(() => {
            if (logCount > 0) {
                // Could add auto-refresh logic here if needed
            }
        }, 5000);
        
        // ============================================================================
        // NEW: Screenshot Processing Diagnostics Event Handlers (CLAUDE.md Compliance)
        // ============================================================================
        
        // Test Single-Screenshot Architecture
        document.getElementById('test-single-screenshot-architecture').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Testing Architecture...';
            
            log('üöÄ Testing single-screenshot architecture...');
            
            try {
                const response = await fetch('/api/test-single-screenshot-architecture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Single-screenshot architecture test completed in ${result.statistics.processing_time_ms}ms`, 'success');
                    displayScreenshotDiagnosticsResults(result, 'single-screenshot');
                } else {
                    log(`‚ùå Single-screenshot architecture test failed: ${result.error}`, 'error');
                    displayScreenshotDiagnosticsResults(result, 'single-screenshot');
                }
            } catch (error) {
                log(`‚ùå Architecture test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üèóÔ∏è Test Single-Screenshot Architecture';
        });
        
        // Test Screenshot Performance
        document.getElementById('test-screenshot-performance').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Benchmarking...';
            
            log('üìä Running screenshot performance benchmarks...');
            
            try {
                const response = await fetch('/api/test-screenshot-performance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    log(`‚úÖ Performance test completed: ${result.performance_metrics.performance_improvement_percent}% improvement`, 'success');
                    displayScreenshotDiagnosticsResults(result, 'performance');
                } else {
                    log(`‚ùå Performance test failed: ${result.error}`, 'error');
                    displayScreenshotDiagnosticsResults(result, 'performance');
                }
            } catch (error) {
                log(`‚ùå Performance test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üìä Test Performance Benchmarks';
        });
        
        // Test Screenshot Validation
        document.getElementById('test-screenshot-validation').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Validating...';
            
            log('üîç Testing screenshot validation...');
            
            try {
                const response = await fetch('/api/test-screenshot-validation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    const validationScore = result.statistics.validation_passed;
                    log(`‚úÖ Validation completed: ${validationScore}/4 checks passed`, 'success');
                    displayScreenshotDiagnosticsResults(result, 'validation');
                } else {
                    log(`‚ùå Validation test failed: ${result.error}`, 'error');
                    displayScreenshotDiagnosticsResults(result, 'validation');
                }
            } catch (error) {
                log(`‚ùå Validation test error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üîç Test Quality Validation';
        });
        
        // Get Screenshot Cache Info
        document.getElementById('get-screenshot-cache-info').addEventListener('click', async function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner"></span>Getting Info...';
            
            log('üìà Getting screenshot cache information...');
            
            try {
                const response = await fetch('/api/screenshot-cache-info', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                
                if (result.success) {
                    const cacheStatus = result.cache_status.valid ? 'Active' : 'Inactive';
                    log(`‚úÖ Cache info retrieved: ${cacheStatus} cache`, 'success');
                    displayScreenshotDiagnosticsResults(result, 'cache-info');
                } else {
                    log(`‚ùå Cache info failed: ${result.error}`, 'error');
                    displayScreenshotDiagnosticsResults(result, 'cache-info');
                }
            } catch (error) {
                log(`‚ùå Cache info error: ${error.message}`, 'error');
            }
            
            button.disabled = false;
            button.innerHTML = 'üìà Get Cache Status';
        });
        
        // Display function for screenshot diagnostics results
        function displayScreenshotDiagnosticsResults(result, testType) {
            let html = '';
            
            if (result.success) {
                html += `<div class="test-section">`;
                html += `<h5>üöÄ ${testType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())} Results</h5>`;
                
                // Test-specific content
                if (testType === 'single-screenshot') {
                    html += `<div class="stats-grid">`;
                    html += `<div class="stat-item"><strong>üì∏ Screenshot:</strong> ${result.screenshot_file}</div>`;
                    html += `<div class="stat-item"><strong>‚ö° Cache Valid:</strong> ${result.cache_performance.cache_valid ? '‚úÖ' : '‚ùå'}</div>`;
                    html += `<div class="stat-item"><strong>üöÄ Same File Reused:</strong> ${result.cache_performance.same_file_reused ? '‚úÖ' : '‚ùå'}</div>`;
                    html += `<div class="stat-item"><strong>‚è±Ô∏è Cache Reuse Time:</strong> ${result.cache_performance.cache_reuse_time_ms}ms</div>`;
                    html += `<div class="stat-item"><strong>üìä Performance Mode:</strong> ${result.session_info.performance_mode}</div>`;
                    html += `<div class="stat-item"><strong>üéØ Architecture Benefit:</strong> ${result.statistics.architecture_benefit}</div>`;
                    html += `</div>`;
                } else if (testType === 'performance') {
                    html += `<div class="stats-grid">`;
                    html += `<div class="stat-item"><strong>üì∏ Screenshot:</strong> ${result.screenshot_file}</div>`;
                    html += `<div class="stat-item"><strong>‚ö° Traditional Avg:</strong> ${result.performance_metrics.traditional_avg_ms}ms</div>`;
                    html += `<div class="stat-item"><strong>üöÄ Optimized:</strong> ${result.performance_metrics.optimized_time_ms}ms</div>`;
                    html += `<div class="stat-item"><strong>üìà Improvement:</strong> ${result.performance_metrics.performance_improvement_percent}%</div>`;
                    html += `<div class="stat-item"><strong>üéØ Cards Detected:</strong> ${result.analysis_results.cards_detected}</div>`;
                    html += `<div class="stat-item"><strong>üë§ Avatars Detected:</strong> ${result.analysis_results.avatars_detected}</div>`;
                    html += `</div>`;
                } else if (testType === 'validation') {
                    html += `<div class="stats-grid">`;
                    html += `<div class="stat-item"><strong>üì∏ Screenshot:</strong> ${result.screenshot_file}</div>`;
                    html += `<div class="stat-item"><strong>‚úÖ Overall Valid:</strong> ${result.quality_score.overall_valid ? '‚úÖ' : '‚ùå'}</div>`;
                    html += `<div class="stat-item"><strong>üìÅ File Integrity:</strong> ${result.quality_score.file_integrity ? '‚úÖ' : '‚ùå'}</div>`;
                    html += `<div class="stat-item"><strong>üìè Dimensions:</strong> ${result.validation_results.width}x${result.validation_results.height}</div>`;
                    html += `<div class="stat-item"><strong>üìã Format:</strong> ${result.validation_results.image_format}</div>`;
                    html += `<div class="stat-item"><strong>üìä Validation Score:</strong> ${result.statistics.validation_passed}/4</div>`;
                    html += `</div>`;
                } else if (testType === 'cache-info') {
                    html += `<div class="stats-grid">`;
                    html += `<div class="stat-item"><strong>üöÄ Cache Status:</strong> ${result.cache_status.valid ? '‚úÖ Active' : '‚ùå Inactive'}</div>`;
                    html += `<div class="stat-item"><strong>‚è±Ô∏è Cache Age:</strong> ${result.cache_status.age_seconds ? result.cache_status.age_seconds.toFixed(1) + 's' : 'N/A'}</div>`;
                    html += `<div class="stat-item"><strong>üìÅ File Exists:</strong> ${result.cache_status.file_exists ? '‚úÖ' : '‚ùå'}</div>`;
                    html += `<div class="stat-item"><strong>üñ•Ô∏è System:</strong> ${result.system_info.system_platform}</div>`;
                    html += `<div class="stat-item"><strong>üéØ Window Detected:</strong> ${result.system_info.window_detected ? '‚úÖ' : '‚ùå'}</div>`;
                    html += `<div class="stat-item"><strong>‚öôÔ∏è Cache Config:</strong> ${result.cache_configuration.cache_expiry_seconds}s expiry</div>`;
                    html += `</div>`;
                }
                
                // Method information
                if (result.method_info) {
                    html += `<div class="method-info">`;
                    html += `<h6>üîß Method Details</h6>`;
                    html += `<div><strong>Module:</strong> ${result.method_info.module_path}</div>`;
                    html += `<div><strong>Technique:</strong> ${result.method_info.technique}</div>`;
                    html += `<div><strong>Features:</strong> ${result.method_info.features}</div>`;
                    html += `</div>`;
                }
                
                html += `</div>`;
            } else {
                html += `<div class="error-message">‚ùå Test Failed: ${result.error}</div>`;
            }
            
            document.getElementById('screenshot-diagnostics-results').innerHTML = 
                `<div class="results-header">üöÄ Screenshot Diagnostics Results</div><div class="results-content">${html}</div>`;
        }
    </script>
</body>
</html>